<!DOCTYPE html>
<button autofocus>Start</button>
<script>
  const tempo = 150;
  const spb = 60 / tempo;
  function clamp(val, minVal, maxVal) {
    return Math.max(minVal, Math.min(val, maxVal));
  }
  function envelopeR(t, rt) {
    return Number(0 <= t) - clamp(t / rt, 0, 1);
  }
  function envelopeAR(t, at, rt) {
    return clamp(t / at, 0, 1) - clamp((t - at) / rt, 0, 1);
  }
  function envelopeASR(t, duration, at, rt) {
    return Math.max(0, (
      clamp(t / at, 0, Math.min(duration / at, 1)) -
      clamp((t - duration) / rt, 0, 1)
    ));
  }
  function envelopeDR(t, duration, dt, rt) {
    return Math.max(0, (
      Number(0 <= t) -
      clamp(t / dt, 0, duration / dt) -
      Math.max(0, (t - duration) / rt)
    ));
  }
  function envelopeADR(t, duration, at, dt, rt) {
    return Math.max(0, (
      clamp(t / at, 0, Math.min(duration / at, 1)) -
      clamp((t - at) / dt, 0, Math.max(0, (duration - at) / dt)) -
      Math.max(0, (t - duration) / rt)
    ));
  }
  function noteNumberFromString(str) {
    const octaveOffset = 12 * (str.codePointAt(0) - "4".codePointAt(0));
    const scaleOffset = { "c": -9, "d": -7, "e": -5, "f": -4, "g":-2, "a": 0, "b": 2 }[str[1]];
    const sharpFlatOffset = (str[2] === "+" ? 1 : 0) + (str[2] === "-" ? -1 : 0);
    return 69 + octaveOffset + scaleOffset + sharpFlatOffset;
  }
  function angularVelocityFromNoteNumber(nn) {
    return 440 * Math.pow(2, (nn - 69) / 12) * Math.PI;
  }
  function toneSine(t, duration, nn) {
    const e = envelopeASR(t, duration, 0.001, 0.01);
    if (e == 0) return 0;
    return 0.125 * e * Math.sin(angularVelocityFromNoteNumber(nn) * t);
  }
  function toneLead1(t, duration, nn) {
    const e = 0.5 * envelopeDR(t, duration, 3, 0.1);
    if (e == 0) return 0;
    const e1 = envelopeR(t, 1);
    const angVel = angularVelocityFromNoteNumber(nn); 
    return 0.040 * e * Math.sin(
      angVel * t +
      16.0 * e1 * Math.sin(3 * angVel * t)
    );
  }
  function toneLead2(t, duration, nn) {
    const e = 0.5 * envelopeDR(t, duration, 3, 0.1);
    if (e == 0) return 0;
    const e1 = envelopeR(t, 1);
    const angVel = angularVelocityFromNoteNumber(nn); 
    return 0.040 * e * Math.sin(
      angVel * t +
      10.0 * e1 * Math.sin(1 * angVel * t)
    );
  }
  function toneSawSynth(t, duration, nn) {
    const e = envelopeDR(t, duration, 3, 0.1);
    if (e == 0) return 0;
    const e1 = envelopeR(t, 1);
    const n = 3;
    let d = 0;
    const angVelBase = angularVelocityFromNoteNumber(nn);
    for (i = 0; i < n; ++i) {
      const angVel = angVelBase + 3 * (-1 * 3 + i) * 2 * Math.PI;
      d += 0.015 / n * Math.sin(
        angVel * t +
        3 * e1 * Math.sin(
          angVel * t +
          3 * e1 * Math.sin(
            angVel * t
          )
        )
      )
    }
    return e * d;
  }
  function toneBass(t, duration, nn) {
    const e = 0.5 * envelopeDR(t, duration, 3, 0.01);
    if (e == 0) return 0;
    const e1 = envelopeR(t, 0.8);
    const angVel = angularVelocityFromNoteNumber(nn);
    return 0.040 * e * Math.sin(
      angVel * t +
      15.0 * e1 * Math.sin(angVel * t)
    );
  }
  function toneCymbal(t, duration, nn) {
    const e = envelopeAR(t, 0.01, 2);
    if (e == 0) return 0;
    const n = 16;
    let d = 0;
    for (let j = 0; j < n; ++j) {
      d += 0.080 / n *
        Math.sin(3000 * (1 + 2 * j / n) * 2 * Math.PI * (
          t + 0.0002 * Math.sin(60 * t * 2 * Math.PI)
        ));
    }
    return d * Math.pow(e, 4);
  }
  function toneHihat(t, duration, nn) {
    const e = envelopeADR(t, duration, 0.0005, 0.3, 0.05);
    const n = 8;
    let d = 0;
    for (let j = 0; j < n; ++j) {
      d += 0.050 / n *
        Math.sin(4500 * (1 + j / n) * 2 * Math.PI * (
          t + 0.0002 * Math.sin(60 * t * 2 * Math.PI)
        ));
    }
    return d * e;
  }
  function toneSnareDrum(t, duration, nn) {
    const e = envelopeR(t, 0.2);
    if (e == 0) return 0;
    let d = 0;
    d += 0.06 * Math.sin(
      100 * t * 2 * Math.PI * (1 + 2 * Math.pow(Math.max(1 - (t / 0.2), 0), 2)) +
      0.02 * Math.sin(40 * t * 2 * Math.PI)
    );
    const n = 8;
    for (let j = 0; j < n; ++j) {
      d += 0.040 / n *
        Math.sin(3000 * (1 + 2 * j / n) * 2 * Math.PI * (
          t + 0.0002 * Math.sin(60 * t * 2 * Math.PI)
        ));
    }
    return d * Math.pow(e, 2);
  }
  function toneBassDrum(t, duration, nn) {
    const e = envelopeR(t, 0.4);
    if (e == 0) return 0;
    const d = 0.10 * Math.sin(
      50 * t * 2 * Math.PI * (1 + 3 * Math.pow(Math.max(0, 1 - (t / 0.4)), 2)) +
      0.5 * Math.sin(40 * t * 2 * Math.PI)
    );
    return d * Math.pow(e, 2);
  }
  function notes(t, toneFunc, params) {
    let d = 0;
    let nt = 0;
    for (let p of params) {
      [noteStr, gateBeat, stepBeat] = p;
      if (stepBeat === undefined) stepBeat = gateBeat;
      d += toneFunc(t - nt, gateBeat * spb, noteNumberFromString(noteStr));
      nt += stepBeat * spb;
    }
    return d;
  }
  function repeat(t, duration, count) {
    if (t < 0) return t;
    if (count * duration <= t) return t - (count - 1) * duration;
    return t % duration;
  }
  function samplePart0(t) {
    if (t < 0 || 4 * spb <= t) return 0;
    let d = 0;
    d += notes(t - 0.5 * spb, toneSawSynth, [
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 0.5],
      ["5b-", 0.5, 0], ["6d", 0.5, 0], ["6a", 0.5],
    ]);
    d += notes(t - 2.5 * spb, toneLead1, [
      ["4g", 0.5], ["5f", 0.5], ["5c", 0.5],
    ]);
    d += notes(t - 0.5 * spb, toneSnareDrum, [
      ["4c", 0.25], ["4c", 0.25], ["4c", 0.25], ["4c", 0.25 + 0.5], 
      ["4c", 1], ["4c", 1]
    ]);
    d += notes(t - 2.5 * spb, toneBassDrum, [
      ["4c", 0]
    ]);
    return d;
  }
  function samplePart1(t) {
    if (t < 0 || 8 * 4 * spb <= t) return 0;
    let d = 0;
    d += notes(t, toneLead1, [
      ["5d", 2, 2 + 0.5],
      ["4b-", 0.5],
      ["5c", 0.5],
      ["5d", 0.5 + 0.75], ["5c", 0.75], ["4b-", 0.5],
      ["4a", 0.75], ["4b-", 0.75], ["5c", 0.5],
      ["5d", 4, 4 + 2.5],
      ["4g", 0.5], ["5f", 0.5], ["5c", 0.5],
      ["5d", 2, 2 + 0.5],
      ["4b-", 0.5],
      ["5c", 0.5],
      ["5d", 0.5 + 0.75], ["5c", 0.75], ["4b-", 0.5],
      ["4a", 0.75], ["4g", 0.75], ["4f", 0.5],
      ["4g", 4, 4 + 2.5],
    ]);
    d += notes(t - 30.5 * spb, toneLead2, [
      ["5g", 0.5], ["6g", 0.5], ["6d", 0.5]
    ]);
    d += notes(t - 0.5 * spb, toneSawSynth, [
      ["5g", 0.5, 0], ["5b-", 0.5],
      ["5d", 0.5, 0], ["5f", 0.5],
      ["5a", 0.5, 0], ["6c", 0.5],
      ["5b-", 1.5, 0], ["6d", 1.5],
      ["5g", 0.5 + 2, 0], ["5b-", 0.5 + 2],
      ["5f", 0.75, 0], ["5a", 0.75],
      ["5g", 0.75, 0], ["5b-", 0.75],
      ["5a", 0.5, 0], ["6c", 0.5, 0.5 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 1 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 2 + 0.5],
      ["5g", 0.5, 0], ["5b-", 0.5],
      ["5d", 0.5, 0], ["5f", 0.5],
      ["5a", 0.5, 0], ["6c", 0.5],
      ["5b-", 1.5, 0], ["6d", 1.5],
      ["5g", 0.5 + 2, 0], ["5b-", 0.5 + 2],
      ["5f", 0.75, 0], ["5a", 0.75],
      ["5g", 0.75, 0], ["5b-", 0.75],
      ["5a", 0.5, 0], ["6c", 0.5, 0.5 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 1 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 2],
    ]);
    d += notes(repeat(t, 1 * spb, 4), toneBass, [
      ["2g", 0.5], ["2g", 0.25], ["3g", 0.25],
    ]);
    d += notes(repeat(t - 4 * spb, 1 * spb, 2), toneBass, [
      ["2e-", 0.5], ["2e-", 0.25], ["3e-", 0.25],
    ]);
    d += notes(repeat(t - 6 * spb, 1 * spb, 2), toneBass, [
      ["2f", 0.5], ["2f", 0.25], ["3f", 0.25],
    ]);
    d += notes(repeat(t - 8 * spb, 1 * spb, 8), toneBass, [
      ["2g", 0.5], ["2g", 0.25], ["3g", 0.25],
    ]);
    d += notes(repeat(t - 16 * spb, 1 * spb, 4), toneBass, [
      ["2g", 0.5], ["2g", 0.25], ["3g", 0.25],
    ]);
    d += notes(repeat(t - 20 * spb, 1 * spb, 2), toneBass, [
      ["2e-", 0.5], ["2e-", 0.25], ["3e-", 0.25],
    ]);
    d += notes(repeat(t - 22 * spb, 1 * spb, 2), toneBass, [
      ["2f", 0.5], ["2f", 0.25], ["3f", 0.25],
    ]);
    d += notes(repeat(t - 24 * spb, 1 * spb, 7), toneBass, [
      ["2g", 0.5], ["2g", 0.25], ["3g", 0.25],
    ]);
    d += notes(t - 31 * spb, toneBass, [
      ["2f", 1]
    ]);
    d += notes(repeat(t - 1 * spb, 2 * spb, 15), toneSnareDrum, [
      ["4c", 0]
    ]);
    d += notes(t - 15 * spb, toneSnareDrum, [
      ["4c", 0.25], ["4c", 0.25], ["4c", 0.25], ["4c", 0.25]
    ]);
    d += notes(repeat(t, 2 * spb, 16), toneBassDrum, [
      ["4c", 0]
    ]);
    d += notes(t, toneCymbal, [["4c", 1]]);
    d += notes(repeat(t, 2 * spb, 16), toneHihat, [
      ["4c", 0.001, 0.5], ["4c", 0.001, 0.25], ["4c", 0.001, 0.25],
      ["4c", 0.4, 0.5], ["4c", 0.001, 0.25], ["4c", 0.001, 0.25],
    ]);
    return d;
  }
  function samplePart2(t) {
    if (t < 0 || 8 * 4 * spb <= t) return 0;
    let d = 0;
    d += notes(t, toneLead2, [
      ["6e-", 2, 2.5], ["6e-", 0.5], ["6f", 0.5], ["6g", 0.5, 0.5 + 1],
      ["6g", 1], ["6f", 0.5], ["6e-", 0.5 + 0.5], ["6f", 0.5 + 3, 0.5 + 3 + 0.5], 
      ["6d", 0.5 + 4]
    ]);
    d += notes(repeat(t, 4 * spb, 2), toneBass, [
      ["2e-", 0.75], ["2e-", 0.75], ["2e-", 0.5, 0.5 + 2],
    ]);
    d += notes(t, toneSawSynth, [
      ["5b-", 3.5, 0], ["6e-", 3.5],
    ]);
    d += notes(repeat(t - 8 * spb, 4 * spb, 2), toneBass, [
      ["2d", 0.75], ["2d", 0.75], ["2d", 0.5, 0.5 + 2],
    ]);
    d += notes(repeat(t, 4 * spb, 4), toneBassDrum, [
      ["4c", 0.75], ["4c", 0.75], ["4c", 0.5 + 2],
    ]);
    d += notes(repeat(t - 3 * spb, 4 * spb, 4), toneSnareDrum, [
      ["4c", 4],
    ]);
    return d;
  }
  function sample(t) {
    return (
      samplePart0(t) +
      samplePart1(t - 4 * spb) +
      samplePart2(t - (4 + 32) * spb)
    );
  }
  let audioCtx = null;
  document.querySelector("button").onclick = () => {
    audioCtx = new AudioContext();
    //const sampleRate = 44100;
    const sampleRate = 22050;
    const startTime = audioCtx.currentTime
    for (let i = 0; i < 10; ++i) {
      const audioBuffer = audioCtx.createBuffer(1, sampleRate, sampleRate);
      const data = audioBuffer.getChannelData(0);
      for (let j = 0; j < sampleRate; ++j) {
        const t = i + j / sampleRate;
        data[j] = sample(t + 32 * spb);
        //data[i] = sample(t + 7 * spb);
      }
      const audioBufferSourceNode = audioCtx.createBufferSource();
      audioBufferSourceNode.buffer = audioBuffer;
      audioBufferSourceNode.connect(audioCtx.destination);
      audioBufferSourceNode.start(startTime + i + 3);
    }
  }
</script>
