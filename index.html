<!DOCTYPE html>
<button autofocus>Start</button>
<script>
  const tempo = 160;
  const spb = 60 / tempo;
  function clamp(val, minVal, maxVal) {
    return Math.max(minVal, Math.min(val, maxVal));
  }
  function envelopeR(t, rt) {
    return Number(0 <= t) - clamp(t / rt, 0, 1);
  }
  function envelopeAR(t, at, rt) {
    return clamp(t / at, 0, 1) - clamp((t - at) / rt, 0, 1);
  }
  function envelopeASR(t, duration, at, rt) {
    return Math.max(0, (
      clamp(t / at, 0, Math.min(duration / at, 1)) -
      clamp((t - duration) / rt, 0, 1)
    ));
  }
  function envelopeDR(t, duration, dt, rt) {
    return Math.max(0, (
      Number(0 <= t) -
      clamp(t / dt, 0, duration / dt) -
      Math.max(0, (t - duration) / rt)
    ));
  }
  function envelopeADR(t, duration, at, dt, rt) {
    return Math.max(0, (
      clamp(t / at, 0, Math.min(duration / at, 1)) -
      clamp((t - at) / dt, 0, Math.max(0, (duration - at) / dt)) -
      Math.max(0, (t - duration) / rt)
    ));
  }
  function noteNumberFromString(str) {
    const octaveOffset = 12 * (str.codePointAt(0) - "4".codePointAt(0));
    const scaleOffset = { "c": -9, "d": -7, "e": -5, "f": -4, "g":-2, "a": 0, "b": 2 }[str[1]];
    const sharpFlatOffset = (str[2] === "+" ? 1 : 0) + (str[2] === "-" ? -1 : 0);
    return 69 + octaveOffset + scaleOffset + sharpFlatOffset;
  }
  function angularVelocityFromNoteNumber(nn) {
    return 440 * Math.pow(2, (nn - 69) / 12) * Math.PI;
  }
  function toneSine(t, duration, nn) {
    const e = envelopeASR(t, duration, 0.001, 0.01);
    if (e == 0) return 0;
    return 0.125 * e * Math.sin(t * angularVelocityFromNoteNumber(nn));
  }
  function tonePiano(t, duration, nn) {
    const e = 0.5 * envelopeDR(t, duration, 3, 0.1);
    if (e == 0) return 0;
    const e1 = envelopeR(t, 1);
    return 0.040 * e * Math.sin(
      t * angularVelocityFromNoteNumber(nn) +
      16.0 * e1 * Math.sin(3 * t * angularVelocityFromNoteNumber(nn))
    );
  }
  function toneBase(t, duration, nn) {
    const e = 0.5 * envelopeDR(t, duration, 3, 0.01);
    if (e == 0) return 0;
    const e1 = envelopeR(t, 1);
    return 0.040 * e * Math.sin(
      t * angularVelocityFromNoteNumber(nn) +
      16.0 * e1 * Math.sin(t * angularVelocityFromNoteNumber(nn))
    );
  }
  function toneCymbal(t, duration, nn) {
    const e = envelopeAR(t, 0.01, 2);
    if (e == 0) return 0;
    const n = 16;
    let d = 0;
    for (let j = 0; j < n; ++j) {
      d += 0.080 / n *
        Math.sin(3000 * (1 + 2 * j / n) * 2 * Math.PI * (
          t + 0.0002 * Math.sin(60 * t * 2 * Math.PI)
        ));
    }
    return d * Math.pow(e, 4);
  }
  function toneHihat(t, duration, nn) {
    const e = envelopeADR(t, duration, 0.0005, 0.3, 0.05);
    const n = 8;
    let d = 0;
    for (let j = 0; j < n; ++j) {
      d += 0.060 / n *
        Math.sin(3500 * (1 + j / n) * 2 * Math.PI * (
          t + 0.0002 * Math.sin(60 * t * 2 * Math.PI)
        ));
    }
    return d * e;
  }
  function toneBassDrum(t, duration, nn) {
    const e = envelopeR(t, 0.4);
    if (e == 0) return 0;
    const d = 0.25 * Math.sin(
      t * 40 * 2 * Math.PI +
      t * 120 * 2 * Math.PI * Math.pow(Math.max(0, 1 - (t / 0.4)), 2) +
      0.5 * Math.sin(40 * t * 2 * Math.PI)
    );
    return d * Math.pow(e, 2);
  }
  function notes(t, toneFunc, params) {
    let d = 0;
    let nt = 0;
    for (let p of params) {
      [noteStr, gateBeat, stepBeat] = p;
      if (stepBeat === undefined) stepBeat = gateBeat;
      d += toneFunc(t - nt, gateBeat * spb, noteNumberFromString(noteStr));
      nt += stepBeat * spb;
    }
    return d;
  }
  function repeat(t, duration, count) {
    if (t < 0) return t;
    if (t + count * duration <= t) return t - duration;
    return t % duration;
  }
  function samplePart0(t) {
    if (t < 0 || 4 * spb <= t) return 0;
    let d = 0;
    d += notes(t - 0.5 * spb, tonePiano, [
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25, 0.25 + 0.5],
      ["5b-", 0.25, 0], ["6d", 0.25, 0], ["6a", 0.25],
    ]);
    d += notes(t - 2.5 * spb, tonePiano, [
      ["4g", 0.5], ["5f", 0.5], ["5c", 0.5],
    ]);
    return d;
  }
  function samplePart1(t) {
    if (t < 0 || 8 * 4 * spb <= t) return 0;
    let d = 0;
    d += notes(t, tonePiano, [
      ["5d", 2, 2 + 0.5],
      ["4b-", 0.5],
      ["5c", 0.5],
      ["5d", 0.5 + 0.75], ["5c", 0.75], ["4b-", 0.5],
      ["4a", 0.75], ["4b-", 0.75], ["5c", 0.5],
    ]);
    d += notes(t, toneBase, [
      ["2g", 0.5], ["3g", 0.25], ["3g", 0.25],
      ["2g", 0.5], ["3g", 0.25], ["3g", 0.25],
      ["2g", 0.5], ["3g", 0.25], ["3g", 0.25],
      ["2g", 0.5], ["3g", 0.25], ["3g", 0.25],
      ["2e-", 0.5], ["3e-", 0.25], ["3e-", 0.25],
      ["2e-", 0.5], ["3e-", 0.25], ["3e-", 0.25],
      ["2f", 0.5], ["3f", 0.25], ["3f", 0.25],
      ["2f", 0.5], ["3f", 0.25], ["3f", 0.25],
    ]);
    d += notes(repeat(t, 1 * spb, 16), toneBassDrum, [
      ["4c", 1]
    ]);
    d += notes(t, toneCymbal, [["4c", 1]]);
    d += notes(repeat(t, 1 * spb, 16), toneHihat, [
      ["4c", 0.001, 0.25], ["4c", 0.001, 0.25], ["4c", 0.4, 0.5],
    ]);
    return d;
  }
  function sample(t) {
    return (
      samplePart0(t) +
      samplePart1(t - 4 * spb)
    );
  }
  let audioCtx = null;
  document.querySelector("button").onclick = () => {
    audioCtx = new AudioContext();
    const sampleRate = 44100;
    const audioBuffer = audioCtx.createBuffer(1, 10 * sampleRate, sampleRate);
    const data = audioBuffer.getChannelData(0);
    for (let i = 0; i < 10 * sampleRate; ++i) {
      const t = i / sampleRate;
      data[i] = sample(t);
    }
    const audioBufferSourceNode = audioCtx.createBufferSource();
    audioBufferSourceNode.buffer = audioBuffer;
    audioBufferSourceNode.connect(audioCtx.destination);
    audioBufferSourceNode.start(audioCtx.currentTime + 0.25);
  }
</script>
